---
import BaseLayout from "../../../../layout/BaseLayout.astro";
import ProjectContent from "../../../../components/ProjectContent.astro";
import { getAllYears, getCategoriesForYear, getProjectsForCategory, getProject } from "../../../../lib/sanity-client";

// This function is required for Static Site Generation (SSG).
// It tells Astro exactly which pages to build by returning an array of route params.
export async function getStaticPaths() {
  // 1. Get all years from Sanity
  const years = await getAllYears();
  const paths = [];

  // 2. Iterate through each year to find its categories
  for (const yearData of years) {
    const yearString = yearData.year.toString();
    const categories = await getCategoriesForYear(yearString);

    // 3. Iterate through each category to find its projects
    for (const category of categories) {
      const categorySlug = category.slug.current;
      const projects = await getProjectsForCategory(categorySlug);

      // 4. Iterate through each project to create a page for it
      for (const project of projects) {
        const projectSlug = project.slug.current;
        // We need the full project details for the page content
        const projectData = await getProject(projectSlug);

        if (projectData) {
          paths.push({
            params: {
              year: yearString,
              category: categorySlug,
              project: projectSlug,
            },
            // We pass the data as props so the page doesn't need to fetch it again
            props: {
              projectData,
              allProjects: projects, // We pass all projects in this category for the sidebar list
            },
          });
        }
      }
    }
  }

  return paths;
}

// Get params from the URL (e.g. /years/2024/film/my-movie)
const { year, category, project } = Astro.params;

// Get data passed from getStaticPaths
const { projectData, allProjects } = Astro.props;

// Get the base path for links (useful if site is hosted in a subdirectory)
const basePath = import.meta.env.BASE_URL.replace(/\/$/, "");

// Safety check: if any required data is missing, redirect to the main years page
if (!year || !category || !project || !projectData) {
  return Astro.redirect("/years/");
}
---

<BaseLayout title={`${projectData.title} - Fyrstikken`} description={projectData.description || "Fyrstikken project"}>
  <ProjectContent
    year={year}
    category={category}
    projectData={projectData}
    allProjects={allProjects}
    basePath={basePath}
  />
</BaseLayout>
