---
import BaseLayout from "../../../layout/BaseLayout.astro";
import CategoryContent from "../../../components/CategoryContent.astro";
import { getAllYears, getCategoriesForYear, getCategory, getProjectsForCategory } from "../../../lib/sanity-client";
import { getBasePath } from "../../../utils/paths";

// This function fetches all the data needed to generate every category page at build time.
export async function getStaticPaths() {
  const years = await getAllYears();
  const paths = [];

  // Iterate through all years
  for (const yearData of years) {
    const yearString = yearData.year.toString();
    // Get categories for this specific year
    const categories = await getCategoriesForYear(yearString);

    // Iterate through each category
    for (const category of categories) {
      const categorySlug = category.slug.current;

      // Fetch detailed category data and the projects within it
      const categoryData = await getCategory(categorySlug);
      const projects = await getProjectsForCategory(categorySlug);

      paths.push({
        params: {
          year: yearString,
          category: categorySlug,
        },
        props: {
          categoryData,
          projects,
        },
      });
    }
  }

  return paths;
}

// Get params and props
const { year, category } = Astro.params;
const { categoryData, projects } = Astro.props;

const basePath = getBasePath();

// Safety check
if (!year || !category || !categoryData) {
  return Astro.redirect("/years/");
}
---

<BaseLayout title={`${category} - Fyrstikken ${year}`} description={`Prosjekter i kategorien ${category}`}>
  <CategoryContent year={year} categoryData={categoryData} projects={projects} basePath={basePath} />
</BaseLayout>
